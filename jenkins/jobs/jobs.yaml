- job-template:
    name: 'Nova-ML2-Sriov'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - delete-mac-nova # remove macs
      #- 'run-tests-{name}-API'
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-basic
      - delete-mac-nova # remove macs
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-advanced
      - delete-mac-nova # remove macs
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log #This line must be the last one

- job-template:
    name: 'Nova-ML2-Sriov-Test'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-Nova-ML2-Sriov
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - delete-mac-nova # remove macs
      #- 'run-tests-{name}-API'
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-basic
      - delete-mac-nova # remove macs
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-advanced
      - delete-mac-nova # remove macs
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log #This line must be the last one



- job-template:
    name: 'Nova-MACVTAP-ML2-Sriov'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx5
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-Nova-MACVTAP-ML2-Sriov
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - delete-mac-nova # remove macs
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-basic
      - delete-mac-nova # remove macs
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-advanced
      - delete-mac-nova # remove macs
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log #This line must be the last one


- job-template:
    name: 'Tempest-Sriov'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - delete-mac-nova # remove macs
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-basic
      - delete-mac-nova # remove macs
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-advanced
      - delete-mac-nova # remove macs
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log #This line must be the last one


- job-template:
    name: 'Neutron-ML2-MLNX'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - 'run-tests-{name}'
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log  #This line must be the last one


- job-template:
    name: 'Neutron-ML2-Sriov'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - delete-mac-nova # remove macs
      #- 'run-tests-{name}-API'
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-basic
      - delete-mac-nova # remove macs
      - add-mac-nova # workaround to add mac to the bridge
      - run-tests-network-advanced
      - delete-mac-nova # remove macs
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log  #This line must be the last one


- job-template:
    name: 'Neutron-Networking-MLNX-ML2'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - 'run-tests-{name}'
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log  #This line must be the last one


- job-template:
    name: 'Ironic-IB'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx5
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      #- apply-workarounds-post-stack-{name}
      - 'run-tests-{name}-API'
      #- 'run-tests-{name}-configure-Real-BM'
      #- 'run-tests-{name}-run-Real-BM'
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log  #This line must be the last one


- job-template:
    name: 'NOOP'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
#      - check-environment
      - mlnx-project-config
#      - clean-environment
      - noop-run
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log #This line must be the last one


- job-template:
    name: 'Cinder-ISER-ISCSI'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - run-tests-cinder
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: mlnx-openstack-ci@dev.mellanox.co.il
          subject: cinder job is being failed, please debug
          failure: true
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log
    wrappers:
      - timeout:
          timeout: 320
          fail: true

- job-template:
    name: 'SimX-Run-ISER-LIO'
    node: '{node}'
    concurrent: false
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx5
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-Cinder-ISER-LIO
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - run-tests-cinder-lio-simx
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: mlnx-openstack-ci@dev.mellanox.co.il
          subject: cinder job is being failed, please debug
          failure: true
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log
    wrappers:
      - timeout:
          timeout: 320
          fail: true

- job-template:
    name: 'SimX-Run-ISER-ISCSI'
    node: '{node}'
    concurrent: false
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx5
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-Cinder-ISER-ISCSI
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - run-tests-cinder-iscsi-simx
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: mlnx-openstack-ci@dev.mellanox.co.il
          subject: cinder job is being failed, please debug
          failure: true
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log
    wrappers:
      - timeout:
          timeout: 320
          fail: true


- job-template:
    name: 'SimX-Run-VM'
    node: '{node}'
    concurrent: true
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx5
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
            SIMX_SNAPSHOT=Simx2.1.2070.nosriov
      - load-vm
      - waitforonline-vm
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: mlnx-openstack-ci@dev.mellanox.co.il
          subject: SimX job is being failed, please debug
          failure: true
      - upload-console-log
    wrappers:
      - timeout:
          timeout: 320
          fail: true


- job-template:
    name: 'Cinder-ISER-LIO'
    node: '{node}'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh # Running Devstack
      - apply-workarounds-post-stack
      - run-tests-cinder
      - produce-readme-file
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: mlnx-openstack-ci@dev.mellanox.co.il
          subject: cinder job is being failed, please debug
          failure: true
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log
    wrappers:
      - timeout:
          timeout: 320
          fail: true


- job-template:
    name: 'Debian-networking-mlnx-build'
    node: master
    triggers:
      - timed: 'H 0 * * *'
      - pollurl:
          cron: 'H * * * *'
          urls:
            - url: 'https://mitaka-jessie.pkgs.mirantis.com/job/networking-mlnx/lastBuild/'
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
      - mlnx-debian-build
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
      - email-ext:
          recipients: lennyb@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true


- job:
    name: Mellanox-CI-Daily-StableNewton-Status
    project-type: multijob
    node:  master
    triggers:
      - timed: 'H 0 * * *'
    builders:
      - multijob:
           name: Mellanox-CI-Daily-StableNewton-Status
           condition: ALWAYS
           projects:
              - name: Nova-ML2-Sriov
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/newton
                   FORCE=yes
              - name: Nova-MACVTAP-ML2-Sriov
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/newton
                   FORCE=yes
              - name: Tempest-Sriov
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/newton
                   FORCE=yes
              - name: Neutron-ML2-Sriov
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/newton
                   FORCE=yes
              - name: Neutron-ML2-MLNX
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/newton
                   FORCE=yes
              - name: Neutron-Networking-MLNX-ML2
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/newton
                   FORCE=yes
              - name: Cinder-ISER-LIO
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/newton
                   FORCE=yes
              - name: Cinder-ISER-ISCSI
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/newton
                   FORCE=yes
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
#    publishers:
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
    wrappers:
      - timeout:
          timeout: 500

- job:
    name: Mellanox-CI-Daily-StableMitaka-Status-Test
    project-type: multijob
    node:  master
#    triggers:
#      - timed: 'H 0 * * *'
    builders:
      - multijob:
           name: Mellanox-CI-Daily-StableMitaka-Status-Test
           condition: ALWAYS
           projects:
              - name: Cinder-ISER-LIO
                node-label-name: CINDER-TEST
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/mitaka
                   FORCE=yes
#                   STEVEDORE_BRANCH=stable/mitaka
#                   PBR_BRANCH=stable/mitaka
#                   NEUTRON_LIB_BRANCH=stable/mitaka
#                   CINDERCLIENT_BRANCH=stable/mitaka
#                   KEYSTONECLIENT_BRANCH=stable/mitaka
#                   NEUTRONCLIENT_BRANCH=stable/mitaka
#                   OSLOCFG_BRANCH=stable/mitaka
#                   OSLOCACHE_BRANCH=stable/mitaka
#                   OSLOPOLICY_BRANCH=stable/mitaka
#                   OSPROFILER_BRANCH=stable/mitaka
#                   OPENSTACKCLIENT_BRANCH=stable/mitaka
#                   TOOZ_BRANCH=stable/mitaka
#                   DIB_BRANCH=stable/mitaka
#                   OSLOUTILS_BRANCH=stable/mitaka
#                   NOVACLIENT_BRANCH=stable/mitaka
#                   GLANCE_STORE_BRANCH=stable/mitaka
#                   OSLOPRIVSEP_BRANCH=stable/mitaka
#                   OSLODB_BRANCH=stable/mitaka
#                   OS_BRICK_BRANCH=stable/mitaka
#                   DIB_UTILS_BRANCH=stable/mitaka
#                   KEYSTONEAUTH_BRANCH=stable/mitaka
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    wrappers:
      - timeout:
          timeout: 500


- job:
    name: Mellanox-CI-Daily-StableMitaka-Status
    project-type: multijob
    node:  master
#    triggers:
#      - timed: 'H 0 * * *'
    builders:
      - multijob:
           name: Mellanox-CI-Daily-StableMitaka-Status
           condition: ALWAYS
           projects:
              - name: Nova-ML2-Sriov
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/mitaka
                   FORCE=yes
              - name: Nova-MACVTAP-ML2-Sriov
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/mitaka
                   FORCE=yes
              - name: Tempest-Sriov
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/mitaka
                   FORCE=yes
              - name: Neutron-ML2-Sriov
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/mitaka
                   FORCE=yes
              - name: Neutron-ML2-MLNX
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/mitaka
                   FORCE=yes
              - name: Neutron-Networking-MLNX-ML2
                current-parameters: true
                predefined-parameters: |
                   ZUUL_BRANCH=stable/mitaka
                   FORCE=yes
#              - name: Cinder-ISER-LIO
#                current-parameters: true
#                predefined-parameters: |
#                   ZUUL_BRANCH=stable/mitaka
#                   FORCE=yes
#              - name: Cinder-ISER-ISCSI
#                current-parameters: true
#                predefined-parameters: |
#                   ZUUL_BRANCH=stable/mitaka
#                   FORCE=yes
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
#    publishers:
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
    wrappers:
      - timeout:
          timeout: 500


- job:
    name: Mellanox-CI-Daily-Master-Status
    project-type: multijob
    node:  master
    triggers:
      - timed: 'H 0 * * *'
    builders:
       - multijob:
           name: Mellanox-CI-Daily-Master-Status
           condition: ALWAYS
           projects:
              - name: Nova-ML2-Sriov
                current-parameters: true
              - name: Nova-MACVTAP-ML2-Sriov
                current-parameters: true
              - name: Tempest-Sriov
                current-parameters: true
              - name: Neutron-ML2-Sriov
                current-parameters: true
              - name: Neutron-ML2-MLNX
                current-parameters: true
              - name: Neutron-Networking-MLNX-ML2
                current-parameters: true
              - name: Cinder-ISER-LIO
                current-parameters: true
              - name: Cinder-ISER-ISCSI
                current-parameters: true
              - name: Nova-ML2-Sriov-Multinode
                current-parameters: true

    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
#    publishers:
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
    wrappers:
      - timeout:
          timeout: 500


######################################################
###               SimX NODE CI     ##################
######################################################
- job:
    name: SimX-Cinder-ISER-LIO
    project-type: multijob
    node: cloudx-17
    concurrent: false
#    triggers:
#      - timed: 'H 0 * * *'
    builders:
       - multijob:
           name: SimX-Run-VM
           condition: ALWAYS
           projects:
              - name: SimX-Run-VM
                current-parameters: true
                predefined-parameters: |
                   HCA=mlx5
                   FORCE=yes
                   SIMX_VM=cloudx-17-07
       - multijob:
           name: SimX-Run-ISER-LIO
           condition: SUCCESSFUL
           projects:
              - name: SimX-Run-ISER-LIO
                current-parameters: true
                predefined-parameters: |
                   HCA=mlx5
                   FORCE=yes
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    wrappers:
      - timeout:
          timeout: 500

- job:
    name: SimX-Cinder-ISER-ISCSI
    project-type: multijob
    node: cloudx-17
#    concurrent: false
#    triggers:
#      - timed: 'H 0 * * *'
    builders:
       - multijob:
           name: Simx-ISCSI
           condition: ALWAYS
           projects:
              - name: SimX-Run-VM
                current-parameters: true
                predefined-parameters: |
                   HCA=mlx5
                   FORCE=yes
                   SIMX_VM=cloudx-17-04
       - multijob:
           name: SimX-Run-ISER-ISCSI
           condition: SUCCESSFUL
           projects:
              - name: SimX-Run-ISER-ISCSI
                current-parameters: true
                predefined-parameters: |
                   HCA=mlx5
                   FORCE=yes
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    wrappers:
      - timeout:
          timeout: 500





######################################################
###               MULTI NODE CI     ##################
######################################################

- job-template:
    name: 'Nova-ML2-Sriov-Multinode-Controller'
    node: '{node}'
    concurrent: false
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
            NODE_TYPE=CONTROLLER
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh
      - apply-workarounds-post-stack
      - apply-workarounds-tempest
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log-mn #This line must be the last one


- job-template:
    name: 'Nova-ML2-Sriov-Multinode-Compute'
    node: '{node}'
    concurrent: false
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
            NODE_TYPE=COMPUTE
      - check-environment
      - mlnx-project-config
      - clean-environment
      - clone-devstack
      - apply-workarounds-pre-stack
      - configure-devstack-{name}
      - run-stacksh
      - apply-workarounds-post-stack
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log-mn #This line must be the last one


- job-template:
    name: 'Nova-ML2-Sriov-Multinode-Tempest'
    node: '{node}'
    concurrent: false
    builders:
      - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/../Nova-ML2-Sriov-Multinode-Controller/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
            NODE_TYPE=CONTROLLER
      - mlnx-project-config
      - run-tests-multinode
      - stop-stacksh
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log-mn #This line must be the last one


- job-template:
    name: 'Nova-ML2-Sriov-Multinode-StopCompute'
    node: '{node}'
    concurrent: false
    parameters:
    builders:
       - inject:
          properties-content: |
            LOGDIR=$WORKSPACE/../Nova-ML2-Sriov-Multinode-Controller/ci-artifacts/logs
            EXT_SERVER=13.69.151.247
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx4
            IMAGE_SERVER=13.69.151.247
            PATH=$PATH:/usr/sbin
            NODE_TYPE=COMPUTE
       - stop-stacksh
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
    publishers:
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
      - upload-console-log-mn #This line must be the last one


- job:
    name: Nova-ML2-Sriov-Multinode
    project-type: multijob
    node: master
    concurrent: false
    builders:
       - multijob:
           name: Controller
           condition: SUCCESSFUL
           projects:
              - name: Nova-ML2-Sriov-Multinode-Controller
                current-parameters: true
       - multijob:
           name: Compute
           condition: SUCCESSFUL
           projects:
              - name: Nova-ML2-Sriov-Multinode-Compute
                current-parameters: true
                predefined-parameters: CONTROLLER_NODE=cloudx-22
       - multijob:
           name: Tempest
           condition: SUCCESSFUL
           projects:
              - name: Nova-ML2-Sriov-Multinode-Tempest
                current-parameters: true
       - multijob:
           name: StopCompute
           condition: ALWAYS
           projects:
              - name: Nova-ML2-Sriov-Multinode-StopCompute
                current-parameters: true
    properties:
      - build-discarder:
          days-to-keep: 100
          num-to-keep: 1000
          artifact-days-to-keep: 100
          artifact-num-to-keep: 500
#    publishers:
#      - build-publisher:
#          name: MellanoxAzureServer
#          publish-unstable-builds: true
#          publish-failed-builds: true
