- project:
    name: BACKUP-CI
    node: master
    jobs:
      - 'BACKUP-CI'

- job-template:
    name: 'BACKUP-CI'
    node: '{node}'
    triggers:
      - timed: '@weekly'
    builders:
      - inject:
          properties-content: |
            LOGDIR=/jenkins/workspace/BACKUP-CI/ci-artifacts/logs
            MAX_LOG_DAYS=60
            LOGDIR=$WORKSPACE/ci-artifacts/logs
            EXT_SERVER=52.169.200.208
            LOGSERVER=cloudx@$EXT_SERVER
            HCA=mlx5
            PATH=$PATH:/usr/sbin
      - backup-ci
    properties:
      - build-discarder:
          days-to-keep: 60
          num-to-keep: 200
          artifact-days-to-keep: 60
          artifact-num-to-keep: 200
    publishers:
      - email-ext:
          recipients: lioros@mellanox.com
          subject: Failed Mellanox CI {name}
          failure: true
          body: "Hello, my dear friend,\nunfortunately we have some issues in CI,\nplease, take a beer and lets take a look\n\n$DEFAULT_CONTENT\nhttp://$EXT_SERVER/$LOG_PATH/\nhttp://$EXT_SERVER/$JOB_NAME_$BUILD_NUMBER"


- builder:
    name: backup-ci
    builders:
         - shell: |
            #!/bin/bash -x

            timestamp=$(date +%Y%m%d_%H%M)
            dest="$LOGDIR/BACKUP/$timestamp"
            sudo chown -R stack $CI_ARTIFACTS

            sudo mkdir -p $dest/etc/
            sudo cp -ra /etc/nodepool $dest/etc

            sudo mkdir -p $dest/etc/default
            sudo cp -ra /etc/default/nodepool $dest/etc/default/

            for user in jenkins nodepool; do
                sudo mkdir -p $dest/$user
                sudo chown -R $user:$user $dest/$user
                sudo cp -ra /home/$user/.ssh $dest/$user/
            done

            sudo mkdir -p $dest/var/lib/jenkins
            sudo chown jenkins:jenkins  $dest/var/lib/jenkins
            sudo -u jenkins cp -ra /var/lib/jenkins/.ssh/*  $dest/var/lib/jenkins

            sudo mkdir $dest/etc/zuul
            sudo cp -ra /etc/zuul/* $dest/etc/zuul

            sudo mkdir -p $dest/var/lib/zuul/ssh
            sudo cp -ra /var/lib/zuul/ssh/id_rsa $dest/var/lib/zuul/ssh

            sudo mkdir $dest/etc/puppet
            sudo cp -ra /etc/puppet/environments/common.yaml $dest/etc/puppet

            sudo cp -ra /etc/jenkins_jobs $dest/etc/

            sudo chown -R stack $dest
            sudo chown -R stack $CI_ARTIFACTS

            gzip -9 -r $dest 2>&1|tee > /dev/null

            UPLOAD_LOGPATH=/BACKUP/$timestamp

            target=/var/www/html/${UPLOAD_LOGPATH}

            ssh $LOGSERVER mkdir -p ${target}

            scp -r $dest/* $LOGSERVER:$target 2>&1 | tee > /dev/null
            # Copy tempest results

            ip=$(echo $LOGSERVER | cut -d'@' -f2)
            echo "Detailed logs: http://$ip/$UPLOAD_LOGPATH"
