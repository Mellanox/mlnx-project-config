- builder:
    name: check-environment
    builders:
        - shell: |
            #!/bin/bash -x
            status=0
            if [ `whoami` != 'stack' ]; then
                echo "Error, user is not stack"
                exit 1
            fi

            for i in `ibdev2netdev | awk '{print $5}'`; do
                sudo ifconfig $i up
            done

            sudo killall -9 radvd 2>&1|tee > /dev/null
            sudo losetup -a

            sudo cat /proc/cmdline |grep intel_iommu
            if [ -z $? ]; then
                echo "please add intel_iommu=on to /boot/grub/menu.lst or /etc/default/grub.cfg"
                exit 1
            fi
            env
            echo "Environment is OK"


- builder:
    name: collect-config-files
    builders:
        - shell: |
            #!/bin/bash -x
            phase="COLLECT CONFIG FILES"
            CI_ARTIFACTS=$LOGDIR/..
            mkdir -p $LOGDIR
            mkdir -p $CI_ARTIFACTS/etc
            mkdir -p $CI_ARTIFACTS/env

            pip --version
            pip freeze 2>&1 | tee > $CI_ARTIFACTS/env/pip-freeze.txt
            dpkg --list > $CI_ARTIFACTS/env/dpkg.txt
            sudo lvs > $CI_ARTIFACTS/env/lvs.txt
            env > $CI_ARTIFACTS/env/environment.txt
            ifconfig > $CI_ARTIFACTS/env/ifconfig.txt
            sudo ovs-vsctl show > $CI_ARTIFACTS/env/ovs-vsctl.txt
            sudo lspci|grep Mellanox > $CI_ARTIFACTS/env/lspci.txt
            sudo uname -a > $CI_ARTIFACTS/env/uname.txt

            sudo cp /etc/modprobe.d/ml* $CI_ARTIFACTS/etc/

            projects=(glance nova neutron eswitchd cinder keystone swift ironic ironic-inspector)
            for project in ${projects[@]}; do
                [ -d /etc/$project ] && cp -r /etc/$project $CI_ARTIFACTS/etc/
            done

            [ -d /opt/stack/tempest/.testrepository ] && cp -L -r /opt/stack/tempest/.testrepository $CI_ARTIFACTS/
            [ -f /opt/stack/tempest/tempest.log ] && cp -L /opt/stack/tempest/tempest.log $LOGDIR/
            [ -f /opt/stack/tempest/etc/tempest.conf ] && cp -L /opt/stack/tempest/etc/tempest.conf $CI_ARTIFACTS
            [ -f $WORKSPACE/devstack/local.conf ] && cp $WORKSPACE/devstack/local.conf $CI_ARTIFACTS
            [ -f /var/log/eswitchd/eswitchd.log ] && cp /var/log/eswitchd/eswitchd.log $LOGDIR

            exit 0


- builder:
    name: clean-environment
    builders:
        - shell: |
            #!/bin/bash -x
            phase="CLEAN-ENVIRONMENT"
            echo "STARTED:############## $phase  ###################"
            echo "Deleting files older than 1 days from /tmp"
            sudo find /tmp -type f -mtime +1 -exec sudo rm -rf {} \;
            sudo find /tmp -type d -mtime +1 -exec sudo rm -rf {} \;
            echo "Deleting archives older than 10 days from /var/log"
            sudo rm -f `sudo find /var/log -name *.gz`

            rm -rf ~/.cache/*
            sudo rm -rf /root/.cache/pip
            sudo rm -rf /var/cache/apt
            sudo sh -c "> /var/log/conntrackd-stats.log"
            sudo sh -c "> /var/log/libvirt/libvirtd.log"
            sudo rm -f `sudo find /var/log -name *.log.*`

            sudo dpkg --configure -a
            sudo dmesg -c > /dev/null

            [ -f /opt/stack/tempest/tempest.log ] && rm -f /opt/stack/tempest/tempest.log

            if [ -d $WORKSPACE/devstack ]; then
                echo "Cleaning up possible remainings of previous builds."
                $WORKSPACE/devstack/clean.sh 2>&1|tee > /dev/null
            fi

            # Remove stack screens leftovers
            sudo screen -wipe

            # Check Cinder leftovers
            if [ $(echo $JOB_NAME|grep Cinder) ]; then
                echo "Cleaning Cinder left volumes"
                sudo pip install rtslib_fb
                sudo lvs
                sudo $WORKSPACE/mlnx-project-config/tools/cinder-rtstool clean
                sudo service tgt restart > /dev/null 2>&1 || true
            fi


            sudo kill $(pgrep rabbitmq)
            sudo kill $(pgrep beam.smp)
            sudo kill $(ps -ef |grep swift | grep pyth | awk '{print $2}')
            sleep 5
            sudo kill -9 $(pgrep rabbitmq)
            sudo kill -9 $(pgrep beam.smp)
            sudo kill -9 $(ps -ef |grep swift | grep pyth | awk '{print $2}')
            sudo kill -9 $(ps -ef |grep neutron-openvswitch-agent | grep -v grep | awk '{print $2}')
            kill -9 $(ps -ef |grep add_mac | grep -v grep | awk '{print $2}') 2>&1|tee > /dev/null

            [ -d /opt/stack/tempest/.testrepository ] && rm -rf /opt/stack/tempest/.testrepository


            for file in `ls /opt/stack/*/requirements.txt`
            do
              sudo pip uninstall -r $file -y 2>&1|tee > /dev/null
            done

            sudo pip install setuptools==20.1.1
            sudo pip install pbr
            sudo pip install eventlet
            sudo pip install six
            sudo pip install jinja2

            sudo yum install python-requests rabbitmq-server -y

            [ -d $WORKSPACE/ci-artifacts ] && rm -rf $WORKSPACE/ci-artifacts
            if [[ -n $ZUUL_PROJECT ]]; then
                project=$(echo $ZUUL_PROJECT | cut -d'/' -f2)
                [ -d /opt/stack/$project] && rm -rf /opt/stack/$project
            fi

            sudo rm -f /var/log/apache2/keystone*

            #Cleaning semaphores"
            for sem in `ipcs -s | grep root|awk '{print $2}'`; do
                for pid in `ipcs -s -i $sem|grep pid -a1|tail -n1|awk '{print $NF}'`; do
                    [ ! -d /proc/$pid ] && sudo ipcrm -s $sem
                done
            done

            #echo killing all python procs
            retries=10
            delay=10
            ps -ef |grep /usr/bin/python |grep -v grep |grep -v ipoibd
            pid=$?
            while [[ $retries -gt 0 ]] && [[ $pid -eq 0 ]]; do
                sleep $delay
                for pid in `ps -ef |grep /usr/bin/python |grep -v grep |grep -v ipoibd |awk '{print $2}'`; do
                    sudo kill $pid
                done
                ps -ef |grep /usr/bin/python |grep -v grep
                pid=$?
                let retries=retries-1
            done

            echo "Check if ipoibd is running"
            ipoibd=`pgrep ipoibd`

            if [[ -n $ipoibd ]]; then
                echo "Restarting ipoibd"
                sudo /sbin/ipoibd -D eth_ipoib & 2>&1|tee > /dev/null
            fi


            for folder in `find /opt/stack -type d -maxdepth 1`; do
                pushd $folder
                echo "folder $PWD"
                git checkout master
                git checkout .
                git pull
                git clean -d -f -x
                popd
            done
            env
            echo "FINISHED:############## $phase  ###################"

- builder:
    name: apply-workarounds-pre-stack
    builders:
        - shell: |
            #!/bin/bash -x
            phase="APPLY-WORKAROUNDS-PRE"
            echo "STARTED: ############## $phase  ###################"

            echo "Delete all Bridges"
            for br in `sudo ovs-vsctl list-br`; do
                sudo ovs-vsctl del-br $br
            done


- builder:
    name: apply-workarounds-post-stack
    builders:
        - shell: |
            #!/bin/bash -x
            phase="APPLY-WORKAROUNDS-POST"
            echo "STARTED: ############## $phase  ###################"

            for i in `ibdev2netdev | awk '{print $5}'`; do
                sudo ifconfig $i up
            done
            for port in `ibdev2netdev |grep _0 | grep Up |awk '{print $5}'`; do
                if [ -z $port ]; then
                    echo "Error finding ipoib port"
                    echo "ibdev2netdev |grep _0 |grep Up |awk '{print $5}'"
                    exit 1
                else
                    sudo ovs-vsctl --may-exist add-port br-$port $port 2>&1|tee> /dev/null
                fi
            done

            sudo modprobe ib_isert 2>&1|tee > /dev/null
            sudo modprobe ib_iser 2>&1|tee > /dev/null

            sudo pip install urllib3 --upgrade

- builder:
    name: apply-workarounds-tempest
    builders:
        - shell: |
            #!/bin/bash -x
            phase="APPLY-WORKAROUNDS-POST-TEMPEST"
            echo "STARTED: ############## $phase  ###################"
            cd /opt/stack/tempest
            git fetch https://git.openstack.org/openstack/tempest refs/changes/47/335447/11 && git cherry-pick FETCH_HEAD
            git fetch https://git.openstack.org/openstack/tempest refs/changes/30/339230/2 && git cherry-pick FETCH_HEAD




- builder:
    name: apply-workarounds-post-stack-Ironic-IB
    builders:
        - shell: |
            #!/bin/bash -x
            phase="APPLY-WORKAROUNDS-POST-Ironic-IB"

            #update
            #/opt/stack/nova/nova/virt/ironic/client_wrapper.py
            #set IRONIC_API_VERSION = (1, 17)
            #/opt/stack/ironic/ironic/api/controllers/v1/versions.py
            #set MIN_VERSION_STRING = '1.17'


- builder:
    name: noop-run
    builders:
      - shell: |
          #!/bin/bash -ex
          env
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          echo "Hello World from "$(hostname)


- builder:
    name: configure-devstack-Neutron-ML2-MLNX
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Neutron-ML2-MLNX"
          echo "STARTED: ############## $phase  ###################"
          if [ "$ZUUL_PROJECT" == "openstack/networking-mlnx" ]; then
              export NETWORKING_MLNX_BRANCH=`echo $ZUUL_CHANGES|cut -d':' -f3`
          fi

          ZUUL_BRANCH=${ZUUL_BRANCH:-'master'}

          if [ $ZUUL_BRANCH != 'master' ]; then
              export MLNX_DRIVER='mlnx'
          else
              export MLNX_DRIVER='mlnx_infiniband'
          fi
          echo "MLNX_DRIVER=$MLNX_DRIVER"
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| grep ib| awk '{print $5}'|tail -n1`
          export epioib_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|head -n1`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port epioib_port=$epioib_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          cat > $WORKSPACE/devstack/local.conf  <<EOF
          [[local|localrc]]
          DOWNLOAD_DEFAULT_IMAGES=False
          IMAGE_URLS="http://$IMAGE_SERVER/images/cirros-mellanox-x86_64-disk-ib.img,"
          MULTI_HOST=False
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port
          PUBLIC_INTERFACE=$mlnx_port
          epioib_port=$epioib_port
          NETWORKING_MLNX_BRANCH=${NETWORKING_MLNX_BRANCH:-\$ZUUL_BRANCH}
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False
          RECLONE=yes
          # Cinder
          VOLUME_BACKING_FILE_SIZE=1000M
          # Keystone
          SERVICE_TOKEN=servicetoken
          # Neutron
          Q_PLUGIN=ml2
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=${MLNX_DRIVER},openvswitch
          Q_AGENT=openvswitch
          Q_USE_DEBUG_COMMAND=False
          Q_USE_SECGROUP=True
          ENABLE_TENANT_VLANS=True
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan
          ENABLE_TENANT_TUNNELS=False
          Q_ML2_TENANT_NETWORK_TYPE=vlan
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=${mlnx_port}
          TENANT_VLAN_RANGE=2:10
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-\${epioib_port}
          ALLOW_NEUTRON_DB_MIGRATIONS=true
          Q_USE_PROVIDERNET_FOR_PUBLIC=False
          # Services
          disable_service n-net n-cauth
          disable_service h-eng h-api h-api-cfn h-api-cw
          disable_service n-xvnc n-novnc horizon
          enable_service neutron q-svc q-agt q-dhcp q-l3 q-meta
          enable_service eswitchd
          enable_service mlnx-agt mlnx_dnsmasq
          enable_plugin neutron_ml2_mlnx git://github.com/openstack/networking-mlnx ${NETWORKING_MLNX_BRANCH}
          # Optional, to enable tempest configuration as part of devstack
          enable_service tempest
          USE_SCREEN=True
          [[post-config|\$NOVA_CONF]]
          [DEFAULT]
          pci_passthrough_whitelist ={"'"address"'":"'"*:'"${mlnx_dev}"'.*"'","'"physical_network"'":"'"default"'"}
          scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, PciPassthroughFilter
          [[post-extra|\$TEMPEST_CONFIG]]
          [compute-feature-enabled]
          #suspend=false
          resize=false
          [network]
          port_vnic_type=direct
          [network-feature-enabled]
          port_admin_state_change=false
          [scenario]
          dhcp_client=
          EOF
          echo "FINISHED: ############## $phase  ###################"

- builder:
    name: configure-devstack-Neutron-ML2-Sriov
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Neutron-ML2-Sriov"
          echo "STARTED: ############## $phase  ###################"
          echo $PATH
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          if [[ $ZUUL_BRANCH == "master" || -z "$ZUUL_BRANCH" ]]; then
              export EXTENSION=fdb
          fi
          cat >  $WORKSPACE/devstack/local.conf <<EOF
          [[local|localrc]]
          DOWNLOAD_DEFAULT_IMAGES=False
          IMAGE_URLS="http://$IMAGE_SERVER/images/mellanox_eth.img,"
          MULTI_HOST=False
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port
          PUBLIC_INTERFACE=$mlnx_port
          EXTENSION=${EXTENSION:-fdb}
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False
          RECLONE=yes
          # Cinder
          VOLUME_BACKING_FILE_SIZE=1000M
          # Keystone
          SERVICE_TOKEN=servicetoken
          # Neutron
          Q_PLUGIN=ml2
          Q_AGENT=openvswitch
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=openvswitch,sriovnicswitch
          Q_USE_DEBUG_COMMAND=False
          Q_USE_SECGROUP=True
          ENABLE_TENANT_VLANS=True
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan
          ENABLE_TENANT_TUNNELS=False
          Q_ML2_TENANT_NETWORK_TYPE=vlan
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=${mlnx_port}
          TENANT_VLAN_RANGE=2:100
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-\${PHYSICAL_INTERFACE}
          ALLOW_NEUTRON_DB_MIGRATIONS=true
          Q_USE_PROVIDERNET_FOR_PUBLIC=False
          # Services
          disable_service n-net n-novnc n-cauth h-eng h-api h-api-cfn h-api-cw
          disable_service n-xvnc n-novnc horizon
          enable_service neutron q-svc q-dhcp q-l3 q-meta q-agt q-qos q-sriov-agt
          enable_plugin neutron git://git.openstack.org/openstack/neutron $NEUTRON_BRANCH
          # Optional, to enable tempest configuration as part of devstack
          enable_service tempest
          USE_SCREEN=True
          [[post-config|\$NOVA_CONF]]
          [DEFAULT]
          pci_passthrough_whitelist ={"'"address"'":"'"*:'"${mlnx_dev}"'.*"'","'"physical_network"'":"'"default"'"}
          scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, PciPassthroughFilter
          [[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]
          [ml2_sriov]
          agent_required=True
          [agent]
          extensions=$EXTENSION
          [FDB]
          shared_physical_device_mappings=default:${mlnx_port}
          [[post-extra|\$TEMPEST_CONFIG]]
          [compute-feature-enabled]
          [network]
          port_vnic_type=direct
          EOF
          echo "FINISHED: ############## $phase  ###################"

- builder:
    name: configure-devstack-Ironic-IB
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Ironic-IB"
          echo "STARTED: ############## $phase  ###################"
          cat > $WORKSPACE/devstack/local.conf <<EOF
          [[local|localrc]]
          #DOWNLOAD_DEFAULT_IMAGES=False
          #IMAGE_URLS="http://$IMAGE_SERVER/images/cirros-mellanox-x86_64-disk-ib.img,"
          MULTI_HOST=False
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          DEFAULT_PASSWORD=password
          SWIFT_TEMPURL_KEY=password
          SWIFT_HASH=password
          SWIFT_ENABLE_TEMPURLS=True
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          RECLONE=yes
          USE_SCREEN=True
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False

          #mlnx_port=\`ibdev2netdev |grep Up |awk '{print $5}'|tail -n1\`
          #epioib_port=\`ibdev2netdev |grep Up |awk '{print $5}'|head -n1\`
          epioib_port=eth2
          #mlnx_dev=\`lspci |grep Mell|head -n1|awk '{print $1}' |  sed s/\.0\$//g\`

          PHYSICAL_INTERFACE=$epioib_port
          PHYSICAL_NETWORK=default
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-${PHYSICAL_INTERFACE}

          disable_service n-net n-novnc horizon
          disable_service heat h-api h-api-cfn h-api-cw h-eng
          disable_service cinder c-sch c-api c-vol
          enable_service ironic ir-api ir-cond
          enable_service neutron q-svc q-agt q-dhcp q-l3 q-meta
          enable_service s-proxy s-object s-container s-account
          enable_service s-proxy s-object s-container s-account
          enable_service tempest

          # microversion patch
          #enable_plugin ironic https://github.com/openstack/ironic refs/changes/58/260358/6

          NOVA_BRANCH=refs/changes/40/266540/11
          enable_plugin ironic https://github.com/openstack/ironic refs/changes/63/264263/24
          enable_plugin ironic-inspector https://github.com/openstack/ironic-inspector refs/changes/57/264257/22
          enable_plugin tempest https://github.com/openstack/tempest refs/changes/07/292307/6

          Q_PLUGIN=ml2
          Q_AGENT=openvswitch
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=openvswitch
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan,flat
          Q_ML2_TENANT_NETWORK_TYPE=vlan

          ENABLE_TENANT_TUNNELS=False
          TENANT_VLAN_RANGE=2:100

          IRONIC_BAREMETAL_BASIC_OPS=True
          IRONIC_INSPECTOR_RAMDISK_ELEMENT=ironic-agent
          IRONIC_INSPECTOR_BUILD_RAMDISK=False
          VIRT_DRIVER=ironic
          IRONIC_DEPLOY_DRIVER=pxe_ssh
          IRONIC_VM_LOG_DIR=$LOGDIR/ironic-bm-logs
          DEFAULT_INSTANCE_TYPE=baremetal
          BUILD_TIMEOUT=600
          IRONIC_CALLBACK_TIMEOUT=600
          IRONIC_BUILD_DEPLOY_RAMDISK=False
          IRONIC_ENABLED_DRIVERS=fake,pxe_ssh,pxe_ipmitool,agent_ipmitool
          IRONIC_VM_EPHEMERAL_DISK=1
          VOLUME_BACKING_FILE_SIZE=1000
          FORCE_CONFIG_DRIVE=True
          IRONIC_VM_SPECS_RAM=1024
          IRONIC_VM_COUNT=1
          IRONIC_DEPLOY_DRIVER_ISCSI_WITH_IPA=True
          IRONIC_RAMDISK_TYPE=coreos
          IRONIC_IPXE_ENABLED=True

          IRONIC_CONDUCTOR_CLEAN_NODES=false
          IRONIC_CONDUCTOR_DEPLOY_CALLBACK_TIMEOUT=600

          IRONIC_INSPECTOR_MANAGE_FIREWALL=False
          IRONIC_VM_SSH_PORT=22

          SCREEN_LOGDIR=/opt/stack/logs/screen
          TEMPEST_ALLOW_TENANT_ISOLATION=False

          [[post-config||/etc/ironic-inspector/inspector.conf]]
          [DEFAULT]
          timeout=120
          [firewall]
          dnsmasq_interface = br-\$epioib_port
          manage_firewall = False

          [[post-config|/etc/neutron/dhcp_agent.ini]]
          [DEFAULT]
          dhcp_broadcast_reply=True

          [[post-config|/etc/ironic/ironic.conf]]
          [conductor]
          clean_nodes=false
          deploy_callback_timeout=600

          [[post-extra|\$TEMPEST_CONFIG]]
          [auth]
          use_dynamic_credentials = True
          [baremetal]
          infrastructure_type = infiniband
          EOF
          echo "FINISHED: ############## $phase  ###################"


- builder:
    name: configure-devstack-Neutron-Networking-MLNX-ML2
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Neutron-Networking-MLNX-ML2"
          echo "STARTED: ############## $phase  ###################"
          if [ "$ZUUL_PROJECT" == "openstack/networking-mlnx" ]; then
              export NETWORKING_MLNX_BRANCH=`echo $ZUUL_CHANGES|cut -d':' -f3`
          fi

          ZUUL_BRANCH=${ZUUL_BRANCH:='master'}

          echo "NETWORKING_MLNX_BRANCH=$NETWORKING_MLNX_BRANCH"

          if [ "$ZUUL_BRANCH" != 'master' ]; then
              export MLNX_DRIVER='sdnmechdriver,mlnx'
          else
              export MLNX_DRIVER='mlnx_sdn_assist,mlnx_infiniband'
          fi
          echo "MLNX_DRIVER=$MLNX_DRIVER"
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          export epioib_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|head -n1`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port epioib_port=$epioib_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          cat > $WORKSPACE/devstack/local.conf <<EOF
          [[local|localrc]]
          DOWNLOAD_DEFAULT_IMAGES=False
          IMAGE_URLS="http://$IMAGE_SERVER/images/cirros-mellanox-x86_64-disk-ib.img,"
          MULTI_HOST=False
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port
          epioib_port=$epioib_port
          PUBLIC_INTERFACE=$mlnx_port
          NETWORKING_MLNX_BRANCH=${NETWORKING_MLNX_BRANCH:-\$ZUUL_BRANCH}
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False
          RECLONE=yes
          # Cinder
          VOLUME_BACKING_FILE_SIZE=1000M
          # Keystone
          SERVICE_TOKEN=servicetoken
          # Neutron
          Q_PLUGIN=ml2
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=${MLNX_DRIVER},openvswitch
          Q_AGENT=openvswitch
          Q_USE_DEBUG_COMMAND=False
          Q_USE_SECGROUP=True
          ENABLE_TENANT_VLANS=True
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan
          ENABLE_TENANT_TUNNELS=False
          Q_ML2_TENANT_NETWORK_TYPE=vlan
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=${mlnx_port}
          TENANT_VLAN_RANGE=2:10
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-${epioib_port}
          ALLOW_NEUTRON_DB_MIGRATIONS=true
          Q_USE_PROVIDERNET_FOR_PUBLIC=False
          # Services
          disable_service n-net n-cauth h-eng h-api h-api-cfn h-api-cw
          disable_service n-xvnc n-novnc horizon
          enable_service neutron q-svc q-dhcp q-l3 q-meta q-agt
          enable_service eswitchd
          enable_service mlnx-agt mlnx_dnsmasq
          enable_plugin neutron_ml2_mlnx git://github.com/openstack/networking-mlnx ${NETWORKING_MLNX_BRANCH}
          # Optional, to enable tempest configuration as part of devstack
          enable_service tempest
          USE_SCREEN=True
          [[post-config|\$NOVA_CONF]]
          [DEFAULT]
          pci_passthrough_whitelist ={"'"address"'":"'"*:'"${mlnx_dev}"'.*"'","'"physical_network"'":"'"default"'"}
          scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, PciPassthroughFilter
          [[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]
          [sdn]
          url = http://127.0.0.1/neo
          domain = cloudx
          username = admin
          password = admin
          [ovs]
          of_interface=ovs-ofctl
          [[post-extra|\$TEMPEST_CONFIG]]
          [compute-feature-enabled]
          resize=false
          [network]
          port_vnic_type=direct
          [network-feature-enabled]
          port_admin_state_change=false
          [scenario]
          dhcp_client=
          EOF
          echo "FINISHED: ############## $phase  ###################"

- builder:
    name: configure-devstack-Nova-MACVTAP-ML2-Sriov
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Nova-MACVTAP-ML2-Sriov"
          echo "STARTED: ############## $phase  ###################"
          HCA=${HCA:-"mlx5"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | awk '{print $5}'`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          if [[ $ZUUL_BRANCH == "master" || -z "$ZUUL_BRANCH" ]]; then
              export EXTENSION=fdb
          fi
          cat > $WORKSPACE/devstack/local.conf <<EOF
          [[local|localrc]]
          DOWNLOAD_DEFAULT_IMAGES=False
          IMAGE_URLS="http://$IMAGE_SERVER/images/mellanox_eth.img,"
          MULTI_HOST=False
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port
          PUBLIC_INTERFACE=$mlnx_port
          EXTENSION=${EXTENSION:-fdb}
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False
          RECLONE=yes
          # Cinder
          VOLUME_BACKING_FILE_SIZE=1000M
          # Keystone
          SERVICE_TOKEN=servicetoken
          # Neutron
          Q_PLUGIN=ml2
          Q_AGENT=openvswitch
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=openvswitch,sriovnicswitch
          Q_USE_DEBUG_COMMAND=False
          Q_USE_SECGROUP=True
          ENABLE_TENANT_VLANS=True
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan
          ENABLE_TENANT_TUNNELS=False
          Q_ML2_TENANT_NETWORK_TYPE=vlan
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=${mlnx_port}
          TENANT_VLAN_RANGE=2:100
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-\${PHYSICAL_INTERFACE}
          ALLOW_NEUTRON_DB_MIGRATIONS=true
          Q_USE_PROVIDERNET_FOR_PUBLIC=False
          # Services
          disable_service n-net n-cauth h-eng h-api h-api-cfn h-api-cw
          disable_service n-xvnc n-novnc horizon
          enable_service neutron q-svc q-dhcp q-l3 q-meta q-agt q-qos q-sriov-agt
          enable_plugin neutron git://git.openstack.org/openstack/neutron $NEUTRON_BRANCH
          # Optional, to enable tempest configuration as part of devstack
          enable_service tempest
          USE_SCREEN=True
          [[post-config|\$NOVA_CONF]]
          [DEFAULT]
          pci_passthrough_whitelist ={"'"address"'":"'"*:'"${mlnx_dev}"'.*"'","'"physical_network"'":"'"default"'"}
          scheduler_available_filters=nova.scheduler.filters.all_filters
          scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, PciPassthroughFilter
          [[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]
          [ml2_sriov]
          supported_pci_vendor_devs=15b3:1014
          [agent]
          extensions=$EXTENSION
          [FDB]
          shared_physical_device_mappings=default:${mlnx_port}
          [[post-extra|\$TEMPEST_CONFIG]]
          [compute-feature-enabled]
          [network]
          port_vnic_type=macvtap
          EOF
          echo "FINISHED: ############## $phase  ###################"


- builder:
    name: configure-devstack-Nova-ML2-Sriov
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Nova-ML2-Sriov"
          echo "STARTED: ############## $phase  ###################"
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          if [[ $ZUUL_BRANCH == "master" || -z "$ZUUL_BRANCH" ]]; then
              export EXTENSION=fdb
          fi
          cat > $WORKSPACE/devstack/local.conf <<EOF
          [[local|localrc]]
          DOWNLOAD_DEFAULT_IMAGES=False
          IMAGE_URLS="http://$IMAGE_SERVER/images/mellanox_eth.img,"
          MULTI_HOST=False
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port
          PUBLIC_INTERFACE=$mlnx_port
          EXTENSION=${EXTENSION:-fdb}
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False
          RECLONE=yes
          # Cinder
          VOLUME_BACKING_FILE_SIZE=1000M
          # Keystone
          SERVICE_TOKEN=servicetoken
          # Neutron
          Q_PLUGIN=ml2
          Q_AGENT=openvswitch
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=openvswitch,sriovnicswitch
          Q_USE_DEBUG_COMMAND=False
          Q_USE_SECGROUP=True
          ENABLE_TENANT_VLANS=True
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan
          ENABLE_TENANT_TUNNELS=False
          Q_ML2_TENANT_NETWORK_TYPE=vlan
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=${mlnx_port}
          TENANT_VLAN_RANGE=2:100
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-\${PHYSICAL_INTERFACE}
          ALLOW_NEUTRON_DB_MIGRATIONS=true
          Q_USE_PROVIDERNET_FOR_PUBLIC=False
          # Services
          disable_service n-net n-cauth h-eng h-api h-api-cfn h-api-cw
          disable_service n-xvnc n-novnc horizon
          enable_service neutron q-svc q-dhcp q-l3 q-meta q-agt q-qos q-sriov-agt
          enable_plugin neutron git://git.openstack.org/openstack/neutron $NEUTRON_BRANCH
          # Optional, to enable tempest configuration as part of devstack
          enable_service tempest
          USE_SCREEN=True
          [[post-config|\$NOVA_CONF]]
          [DEFAULT]
          pci_passthrough_whitelist ={"'"address"'":"'"*:'"${mlnx_dev}"'.*"'","'"physical_network"'":"'"default"'"}
          scheduler_available_filters=nova.scheduler.filters.all_filters
          scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, PciPassthroughFilter
          [[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]
          [ml2_sriov]
          agent_required=True
          [agent]
          extensions=$EXTENSION
          [FDB]
          shared_physical_device_mappings=default:${mlnx_port}
          [[post-extra|\$TEMPEST_CONFIG]]
          [compute-feature-enabled]
          [network]
          port_vnic_type=direct
          EOF
          echo "FINISHED: ############## $phase  ###################"


- builder:
    name: configure-devstack-Tempest-Sriov
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Tempest-Sriov"
          echo "STARTED: ############## $phase  ###################"
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          if [[ $ZUUL_BRANCH == "master" || -z "$ZUUL_BRANCH" ]]; then
              export EXTENSION=fdb
          fi
          cat > $WORKSPACE/devstack/local.conf <<EOF
          [[local|localrc]]
          DOWNLOAD_DEFAULT_IMAGES=False
          IMAGE_URLS="http://$IMAGE_SERVER/images/mellanox_eth.img,"
          MULTI_HOST=False
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port
          PUBLIC_INTERFACE=$mlnx_port
          EXTENSION=${EXTENSION:-fdb}
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False
          RECLONE=yes
          # Cinder
          VOLUME_BACKING_FILE_SIZE=1000M
          # Keystone
          SERVICE_TOKEN=servicetoken
          # Neutron
          Q_PLUGIN=ml2
          Q_AGENT=openvswitch
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=openvswitch,sriovnicswitch
          Q_USE_DEBUG_COMMAND=False
          Q_USE_SECGROUP=True
          ENABLE_TENANT_VLANS=True
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan
          ENABLE_TENANT_TUNNELS=False
          Q_ML2_TENANT_NETWORK_TYPE=vlan
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=${mlnx_port}
          TENANT_VLAN_RANGE=2:100
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-\${PHYSICAL_INTERFACE}
          ALLOW_NEUTRON_DB_MIGRATIONS=true
          Q_USE_PROVIDERNET_FOR_PUBLIC=False
          # Services
          disable_service n-net n-cauth h-eng h-api h-api-cfn h-api-cw
          disable_service n-xvnc n-novnc horizon
          enable_service neutron q-svc q-dhcp q-l3 q-meta q-agt q-qos q-sriov-agt
          enable_plugin neutron git://git.openstack.org/openstack/neutron $NEUTRON_BRANCH
          # Optional, to enable tempest configuration as part of devstack
          enable_service tempest
          USE_SCREEN=True
          [[post-config|\$NOVA_CONF]]
          [DEFAULT]
          pci_passthrough_whitelist ={"'"address"'":"'"*:'"${mlnx_dev}"'.*"'","'"physical_network"'":"'"default"'"}
          scheduler_available_filters=nova.scheduler.filters.all_filters
          scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, PciPassthroughFilter
          [[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]
          [ml2_sriov]
          agent_required=True
          [agent]
          extensions=$EXTENSION
          [FDB]
          shared_physical_device_mappings=default:${mlnx_port}
          [[post-extra|\$TEMPEST_CONFIG]]
          [compute-feature-enabled]
          #suspend=False
          [network]
          port_vnic_type=direct
          EOF
          echo "FINISHED: ############## $phase  ###################"

- builder:
    name: configure-devstack-Nova-ML2-Sriov-Multinode-Compute
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Multinode-Compute"
          echo "STARTED: ############## $phase  ###################"
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          env
          export CONTROLLER_NODE=${CONTROLLER_NODE:-"cloudx-22"}
          cat > $WORKSPACE/devstack/local.conf <<EOF
          [[local|localrc]]
          DOWNLOAD_DEFAULT_IMAGES=False
          MULTI_HOST=1
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port
          PUBLIC_INTERFACE=$mlnx_port
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False
          RECLONE=yes
          # Cinder
          VOLUME_BACKING_FILE_SIZE=1000M
          # Keystone
          SERVICE_TOKEN=servicetoken
          # Neutron
          Q_PLUGIN=ml2
          Q_AGENT=openvswitch
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=openvswitch,sriovnicswitch
          Q_USE_DEBUG_COMMAND=False
          Q_USE_SECGROUP=True
          ENABLE_TENANT_VLANS=True
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan
          ENABLE_TENANT_TUNNELS=False
          Q_ML2_TENANT_NETWORK_TYPE=vlan
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=${mlnx_port}
          TENANT_VLAN_RANGE=2:100
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-\${PHYSICAL_INTERFACE}
          SERVICE_HOST=$CONTROLLER_NODE
          MYSQL_HOST=$CONTROLLER_NODE
          RABBIT_HOST=$CONTROLLER_NODE
          Q_HOST=$CONTROLLER_NODE
          GLANCE_HOSTPORT=$CONTROLLER_NODE:9292
          NOVA_VNC_ENABLED=True
          NOVNCPROXY_URL="http://$CONTROLLER_NODE:6080/vnc_auto.html"
          VNCSERVER_LISTEN=\$HOST_IP
          VNCSERVER_PROXYCLIENT_ADDRESS=\$VNCSERVER_LISTEN
          ALLOW_NEUTRON_DB_MIGRATIONS=true
          Q_USE_PROVIDERNET_FOR_PUBLIC=False
          # Services
          ENABLED_SERVICES=n-cpu,q-agt,n-api-meta,n-novnc,n-xvnc,q-qos,q-sriov-agt
          enable_plugin neutron git://git.openstack.org/openstack/neutron
          disable_service tempest n-cauth
          USE_SCREEN=True
          [[post-config|\$NOVA_CONF]]
          [DEFAULT]
          pci_passthrough_whitelist ={"'"address"'":"'"*:'"${mlnx_dev}"'.*"'","'"physical_network"'":"'"default"'"}
          scheduler_available_filters=nova.scheduler.filters.all_filters
          scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, PciPassthroughFilter
          [[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]
          [ml2_sriov]
          agent_required=True
          EOF
          echo "FINISHED: ############## $phase  ###################"


- builder:
    name: configure-devstack-Nova-ML2-Sriov-Multinode-Controller
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CONFIGURE-DEVSTACK-Multinode-Controller"
          echo "STARTED: ############## $phase  ###################"
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          echo "HCA=$HCA, mlnx_dev=$mlnx_dev mlnx_port=$mlnx_port"
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi
          env
          cat > $WORKSPACE/devstack/local.conf <<EOF
          [[local|localrc]]
          DOWNLOAD_DEFAULT_IMAGES=False
          IMAGE_URLS="http://$IMAGE_SERVER/images/mellanox_eth.img,"
          MULTI_HOST=1
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          LIBS_FROM_GIT=python-neutronclient
          SERVICE_TOKEN=servicetoken
          IDENTITY_API_VERSION=3
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port
          PUBLIC_INTERFACE=$mlnx_port
          # Logging
          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          LOG_COLOR=False
          RECLONE=yes
          # Cinder
          VOLUME_BACKING_FILE_SIZE=1000M
          # Keystone
          SERVICE_TOKEN=servicetoken
          # Neutron
          Q_PLUGIN=ml2
          Q_AGENT=openvswitch
          Q_ML2_PLUGIN_MECHANISM_DRIVERS=openvswitch,sriovnicswitch
          Q_USE_DEBUG_COMMAND=False
          Q_USE_SECGROUP=True
          ENABLE_TENANT_VLANS=True
          Q_ML2_PLUGIN_TYPE_DRIVERS=vlan
          ENABLE_TENANT_TUNNELS=False
          Q_ML2_TENANT_NETWORK_TYPE=vlan
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=${mlnx_port}
          TENANT_VLAN_RANGE=2:100
          NETWORK_API_EXTENSIONS=dhcp_agent_scheduler,external-net,ext-gw-mode,binding,quotas,agent,l3_agent_scheduler,provider,router,extraroute,security-group
          OVS_PHYSICAL_BRIDGE=br-\${PHYSICAL_INTERFACE}
          ALLOW_NEUTRON_DB_MIGRATIONS=true
          Q_USE_PROVIDERNET_FOR_PUBLIC=False
          # Services
          disable_service horizon h-eng h-api h-api-cfn h-api-cw
          enable_service neutron q-svc q-agt q-dhcp q-l3 q-meta q-qos q-sriov-agt tempest n-novnc n-xvnc n-cpu
          enable_plugin neutron git://git.openstack.org/openstack/neutron
          USE_SCREEN=True
          [[post-config|\$NOVA_CONF]]
          [DEFAULT]
          pci_passthrough_whitelist ={"'"address"'":"'"*:'"${mlnx_dev}"'.*"'","'"physical_network"'":"'"default"'"}
          scheduler_available_filters=nova.scheduler.filters.all_filters
          scheduler_default_filters = RetryFilter, AvailabilityZoneFilter, RamFilter, ComputeFilter, ComputeCapabilitiesFilter, ImagePropertiesFilter, PciPassthroughFilter
          [[post-config|/etc/neutron/plugins/ml2/ml2_conf.ini]]
          [ml2_sriov]
          agent_required=True
          supported_pci_vendor_devs = 15b3:1004, 15b3:1014
          [agent]
          extensions=fdb
          [FDB]
          shared_physical_device_mappings=default:${mlnx_port}
          [[post-extra|\$TEMPEST_CONFIG]]
          [compute-feature-enabled]
          suspend=False
          migrate=True
          [compute]
          min_compute_nodes=2
          [network]
          port_vnic_type=direct
          EOF
          echo "FINISHED: ############## $phase  ###################"


- builder:
    name: mlnx-project-config
    builders:
       - shell: |
          #!/bin/bash +ex
          phase="EXTERNAL-TESTING-CHECKOUT"
          echo "STARTED: ############## $phase  ###################"
          if [ -d $WORKSPACE/mlnx-project-config ];then
              pushd $WORKSPACE/mlnx-project-config
              git pull
              popd
          else
              git clone https://github.com/Mellanox/mlnx-project-config.git
          fi
          echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-stacksh
    builders:
      - shell: |
          #!/bin/bash
          phase="RUN-STACKSH"
          echo "STARTED: ############## $phase  ###################"v
          if [[ -n $ZUUL_PROJECT ]]; then
              project=$(echo $ZUUL_PROJECT | cut -d'/' -f2)
              refspec=$(echo ${ZUUL_CHANGES##*^} | cut -d':' -f3)
              project=${project//-/_}
              export ${project^^}_BRANCH=$refspec
          fi
          #For latest Ubuntu
          #export FORCE=yes
          export ESWITCHD_BRANCH="master"

          BUILD_ID=dontKillMe $WORKSPACE/devstack/stack.sh
          rc=$?

          if [[ $rc -ne 0 ]]; then
              echo "FINISHED with ERROR $rc: ############## $phase  ###################"
              exit $rc
          fi
          echo "############## Stack is up and running ###################"
          echo "FINISHED: ############## $phase  ###################"
          exit 0

- builder:
    name: stop-stacksh
    builders:
      - shell: |
          #!/bin/bash -x
          phase="STOP-STACKSH"
          echo "STARTED: ############## $phase  ###################"

          #For latest Ubuntu
          #export FORCE=yes
          if [ -f $WORKSPACE/devstack/unstack.sh ];then
             $WORKSPACE/devstack/unstack.sh 2>&1|tee > /dev/null
          fi
          echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-tests-Ironic-IB-API
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-IRONIC-IB-API"
            echo "STARTED: ############## $phase  ###################"
            cd /opt/stack/tempest
            tests=ironic_tempest_plugin.tests.api
            testr init
            testr list-tests ${tests[@]}
            testr run ${tests[@]}
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-tests-Ironic-IB-configure-Real-BM
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-IRONIC-IB-configure-Real-BM"
            echo "STARTED: ############## $phase  ###################"
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-tests-Ironic-IB-run-Real-BM
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-IRONIC-IB-run-Real-BM"
            echo "STARTED: ############## $phase  ###################"
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            echo "FINISHED: ############## $phase  ###################"




- builder:
    name: run-tests-Neutron-ML2-MLNX
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-NEUTRON-ML2-MLNX"
            echo "STARTED: ############## $phase  ###################"
            tests=(tempest.api.network.admin.test_dhcp
                tempest.api.network.admin.test_agent
                tempest.api.network.test_floating_ips
                tempest.api.network.test_networks
                tempest.api.network.test_extensions
                #tempest.scenario.test_network_basic_ops
                #tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_preserve_preexisting_port
                #LNY TOFIX test_router_rescheduling works on old Ubuntu CI
                #tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_router_rescheduling
                #tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_update_router_admin_state
                #tempest.scenario.test_network_advanced_server_ops
                tempest.scenario.test_network_advanced_server_ops.TestNetworkBasicOps.test_server_connectivity_pause_unpause
                tempest.scenario.test_network_advanced_server_ops.TestNetworkBasicOps.test_server_connectivity_reboot
            )
            cd /opt/stack/tempest
            testr init
            testr list-tests ${tests[@]}
            testr run ${tests[@]}
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-tests-Neutron-ML2-Sriov-API
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-Neutron-ML2-Sriov-API"
            echo "STARTED: ############## $phase  ###################"
            tests=(tempest.api.network.admin.test_dhcp
                tempest.api.network.admin.test_agent
                tempest.api.network.test_floating_ips
                tempest.api.network.test_networks
                tempest.api.network.test_routers
                tempest.api.network.test_extensions
            )
            cd /opt/stack/tempest
            testr init
            testr list-tests ${tests[@]}
            testr run ${tests[@]}
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-tests-Neutron-Networking-MLNX-ML2
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-NEUTRON-NETWORKING-MLNX-ML2"
            echo "STARTED: ############## $phase  ###################"
            tests=(tempest.api.network.admin.test_dhcp
                tempest.api.network.admin.test_agent
                tempest.api.network.test_floating_ips
                tempest.api.network.test_networks
                tempest.api.network.test_extensions
                tempest.scenario.test_network_basic_ops
                tempest.scenario.test_network_advanced_server_ops
                )
            pushd /opt/stack/tempest
            testr init
            testr list-tests ${tests[@]}
            testr run ${tests[@]}
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            popd
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-tests-network-basic
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-NETWORK-BASIC"
            echo "STARTED: ############## $phase  ###################"
            tests=(
                #tempest.scenario.test_network_basic_ops
                tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_connectivity_between_vms_on_different_networks
                tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_hotplug_nic
                tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_network_basic_ops
                tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_port_security_macspoofing_port
                #tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_preserve_preexisting_port
                tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_router_rescheduling
                tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_subnet_details
                tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_update_instance_port_admin_state
                tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_update_router_admin_state
            )
            pushd /opt/stack/tempest
            testr init
            testr list-tests ${tests[@]}
            testr run ${tests[@]}
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            popd
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-tests-sanity-check
    builders:
        - shell: |
            #!/bin/bash -ex
            phase="RUN-TESTS-SANITY"
            echo "STARTED: ############## $phase  ###################"
            neutron net-list
            cd /opt/stack/tempest
            testr init
            testr run tempest.scenario.test_network_basic_ops.TestNetworkBasicOps
            cd -


- builder:
    name: run-tests-network-advanced
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-NETWORK-ADVANCED"
            echo "STARTED: ############## $phase  ###################"
            tests=(
                tempest.scenario.test_network_advanced_server_ops
            )
            pushd /opt/stack/tempest
            testr init
            testr list-tests ${tests[@]}
            testr run ${tests[@]}
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            popd
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: run-tests-multinode
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-MULTINODE"
            echo "STARTED: ############## $phase  ###################"
            tests=(
                  #TOFIX tests fail unless nova sch is restarted. Seems that sch ignoring schedule_hints
                  tempest.scenario.test_server_multinode.TestServerMultinode.test_schedule_to_all_nodes
                  tempest.scenario.test_server_migrate.TestServerMultinode.test_migrate_nodes
                  tempest.scenario.test_network_advanced_server_ops.TestNetworkAdvancedServerOps.test_server_connectivity_migration
            )
            pushd /opt/stack/tempest
            testr init
            testr list-tests ${tests[@]}
            testr run ${tests[@]}
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            popd
            echo "FINISHED: ############## $phase  ###################"


- builder:
    name: run-tests-Nova-ML2-Sriov-API
    builders:
        - shell: |
            #!/bin/bash
            phase="RUN-TESTS-Nova-ML2-Sriov-API"
            echo "STARTED: ############## $phase  ###################"
            tests=(
                tempest.api.compute.servers.test_server_personality
                tempest.api.compute.servers.test_virtual_interfaces_negative
                tempest.api.compute.servers.test_list_server_filters
                tempest.api.compute.servers.test_multiple_create_negative
                tempest.api.compute.servers.test_server_metadata
                tempest.api.compute.servers.test_attach_interfaces
                tempest.api.compute.servers.test_server_addresses_negative
                tempest.api.compute.servers.test_availability_zone
                tempest.api.compute.servers.test_server_group
                tempest.api.compute.servers.test_server_password
                tempest.api.compute.servers.test_create_server
                tempest.api.compute.servers.test_multiple_create
                tempest.api.compute.servers.test_servers_negative
                tempest.api.compute.servers.test_virtual_interfaces
                tempest.api.compute.servers.test_server_metadata_negative
                tempest.api.compute.servers.test_server_actions
                tempest.api.compute.servers.test_servers
                tempest.api.compute.servers.test_instance_actions
                tempest.api.compute.servers.test_server_addresses
                tempest.api.compute.servers.test_list_servers_negative
                tempest.api.compute.servers.test_instance_actions_negative
                tempest.api.compute.servers.test_disk_config
                tempest.api.compute.certificates.test_certificates
                tempest.api.compute.flavors.test_flavors_negative
                tempest.api.compute.flavors.test_flavors
                tempest.api.compute.test_authorization
                tempest.api.compute.volumes.test_volumes_negative
                tempest.api.compute.test_live_block_migration
                tempest.api.compute.images.test_image_metadata_negative
                tempest.api.compute.images.test_images_oneserver
                tempest.api.compute.images.test_image_metadata
                tempest.api.compute.images.test_list_image_filters_negative
                tempest.api.compute.images.test_images_oneserver_negative
                tempest.api.compute.images.test_images_negative
                tempest.api.compute.images.test_list_images
                tempest.api.compute.images.test_list_image_filters
                tempest.api.compute.images.test_images
                tempest.api.compute.admin.test_security_groups
                tempest.api.compute.admin.test_flavors_access_negative
                tempest.api.compute.admin.test_flavors_negative
                tempest.api.compute.admin.test_flavors_extra_specs
                tempest.api.compute.admin.test_flavors_extra_specs_negative
                tempest.api.compute.admin.test_simple_tenant_usage_negative
                tempest.api.compute.admin.test_availability_zone
                tempest.api.compute.admin.test_quotas_negative
                tempest.api.compute.admin.test_hosts_negative
                tempest.api.compute.admin.test_fixed_ips_negative
                tempest.api.compute.admin.test_fixed_ips
                tempest.api.compute.admin.test_hosts
                tempest.api.compute.admin.test_services_negative
                tempest.api.compute.admin.test_instance_usage_audit_log_negative
                tempest.api.compute.admin.test_availability_zone_negative
                tempest.api.compute.admin.test_aggregates
                tempest.api.compute.admin.test_aggregates_negative
                tempest.api.compute.admin.test_networks
                tempest.api.compute.admin.test_simple_tenant_usage
                tempest.api.compute.admin.test_servers_negative
                tempest.api.compute.admin.test_hypervisor
                tempest.api.compute.admin.test_servers
                tempest.api.compute.admin.test_quotas
                tempest.api.compute.admin.test_flavors_access
                tempest.api.compute.admin.test_floating_ips_bulk
                tempest.api.compute.admin.test_security_group_default_rules
                tempest.api.compute.admin.test_hypervisor_negative
                tempest.api.compute.admin.test_instance_usage_audit_log
                tempest.api.compute.admin.test_services
                tempest.api.compute.admin.test_baremetal_nodes
                tempest.api.compute.admin.test_migrations
                tempest.api.compute.admin.test_agents
                tempest.api.compute.admin.test_flavors
                tempest.api.compute.limits.test_absolute_limits_negative
                tempest.api.compute.limits.test_absolute_limits
                tempest.api.compute.test_extensions
                tempest.api.compute.test_live_block_migration_negative
                tempest.api.compute.floating_ips.test_list_floating_ips
                tempest.api.compute.floating_ips.test_floating_ips_actions
                tempest.api.compute.floating_ips.test_floating_ips_actions_negative
                tempest.api.compute.floating_ips.test_list_floating_ips_negative
                tempest.api.compute.floating_ips.base
                tempest.api.compute.test_networks
                tempest.api.compute.keypairs.test_keypairs_negative
                tempest.api.compute.keypairs.test_keypairs
                tempest.api.compute.test_quotas
                tempest.api.compute.test_tenant_networks
                tempest.api.compute.security_groups.base
            )
            tests=(
                tempest.api.compute.servers.test_server_actions.ServerActionsTestJSON.test_resize_server_confirm
                tempest.api.compute.servers.test_server_actions.ServerActionsTestJSON.test_resize_server_revert
                )

            pushd /opt/stack/tempest
            testr init
            testr list-tests ${tests[@]}
            testr run ${tests[@]}
            test_pass=$?
            if [[ $test_pass -ne 0 ]]; then
                echo "FINISHED with ERROR: ############## $phase  ###################"
                exit 1
            fi
            popd
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: collect-artifacts
    builders:
      - shell: |
          #!/bin/bash -eE
          phase="COLLECT-ARTIFACTS"
          echo "STARTED: ############## $phase  ###################"
          CI_ARTIFACTS=$(dirname ${LOGDIR})
          dmesg > $CI_ARTIFACTS/logs/dmesg.log
          echo "TGT Status"
          sudo service tgt status 2>&1 |tee

          testrepository=/opt/stack/tempest/.testrepository/0
          if [[ -f $testrepository ]]; then
              pushd /opt/stack/tempest/.testrepository
              tmp_subunit=/tmp/tempest_results_$$
              for file in `find . -regex '.*[0-9][0-9]?'`
                  do cat $file >> $tmp_subunit
              done
              $WORKSPACE/mlnx-project-config/tools/subunit2html.py $tmp_subunit $CI_ARTIFACTS/testr_results.html
              rm -f $tmp_subunit
              popd
          fi

          source=/tmp/ci-artifacts_$$
          rsync $CI_ARTIFACTS/* $source -a --copy-links -v 2>&1|tee > /dev/null
          rm -f $source/logs/*.log.* 2>&1|tee > /dev/null

          grep -rn Traceb $source/logs/*.log 2>&1|tee > $source/logs/exceptions.txt

          gzip -9 -r $source 2>&1|tee > /dev/null
          rm -rf $CI_ARTIFACTS
          cp -r $source $CI_ARTIFACTS
          chmod +r -R $CI_ARTIFACTS
          rm -rf $source

          # NOTE: this is based on the fact that all MultiNode nodes labled as SRIOV_MN_CONTROLLER
          # or SRIOV_MN_COMPUTE
          NODE_TYPE=`echo $NODE_LABELS |grep 'SRIOV_MN'|cut  -d' ' -f1|cut -d'_' -f3`

          UPLOAD_LOGPATH_TEMPEST=${LOG_PATH:-${JOB_NAME}/${BUILD_NUMBER}_${NODE_NAME}}
          UPLOAD_LOGPATH=${UPLOAD_LOGPATH_TEMPEST}/${NODE_TYPE}

          target=/var/www/html/${UPLOAD_LOGPATH}

          ssh $LOGSERVER mkdir -p ${target}

          scp -r $CI_ARTIFACTS/* $LOGSERVER:$target 2>&1 | tee > /dev/null
          # Copy tempest results
          scp -r $CI_ARTIFACTS/te* $LOGSERVER:/var/www/html/$UPLOAD_LOGPATH_TEMPEST  2>&1|tee > /dev/null

          ip=$(echo $LOGSERVER | cut -d'@' -f2)
          echo "Detailed logs: http://$ip/$UPLOAD_LOGPATH"
          echo "Tempest results: http://$ip/$UPLOAD_LOGPATH/testr_results.html.gz"

          if [ ! -z "$LOG_PATH" ]; then
              REVIEW_PATH=`echo $UPLOAD_LOGPATH|cut -d'/' -f2`
              echo "https://review.openstack.org/#/c/$REVIEW_PATH"
          fi

          echo "FINISHED: ############## $phase  ###################"


- builder:
    name: produce-readme-file
    builders:
      - shell: |
          #!/bin/bash -ex
          if [ ! -d $LOGDIR ];then
          mkdir -p $LOGDIR
          fi
          cat > $LOGDIR/README <<EOF
          Mellanox 3rd party CI
          ---------------------
          Job Name: $JOB_NAME
          Build started at `date --universal`

          Contact information:
          Email: lennyb@mellanox.com
          IRC: lennyb on #openstack-infra
          EOF

- builder:
    name: clone-devstack
    builders:
      - shell: |
          #!/bin/bash -ex
          phase="CLONE-DEVSTACK"
          echo "STARTED: ############## $phase  ###################"

          devstack_repo=git://git.openstack.org/openstack-dev/devstack
          retries=10
          if [[ ! -d $WORKSPACE/devstack ]];then
              git clone $devstack_repo
          fi
          pushd $WORKSPACE/devstack

          ZUUL_BRANCH=${ZUUL_BRANCH:='master'}
          git fetch
          git checkout $ZUUL_BRANCH
          git pull

          #workaround remove old cloud.yaml to avoid keystone auth problems
          rm -rf ~/.config/openstack
          echo "FINISHED: ############## $phase  ###################"


- builder:
    name: add-mac-nova
    builders:
        - shell: |
            #!/bin/bash
            #Prepare  environment
            phase="ADD-MAC-NOVA"
            echo "STARTED: ############## $phase  ###################"
            WORKSPACE=${WORKSPACE:-$(dirname `readlink -f -- $0`)}
            echo "WORKSPACE=$WORKSPACE"
            if [[ "\$ZUUL_BRANCH" == "master" || -z "\$ZUUL_BRANCH" ]]; then
                exit 0
            fi

            source $WORKSPACE/devstack/openrc admin

            # Start script to add macs to default gateway
            echo "NOVA CI add macs"
            ADD_MAC='/tmp/add_mac.sh'
            HCA=${HCA:-"mlx4"}
            mlnx_port=`ibdev2netdev |grep $HCA|grep Up | awk '{print $5}' | head -n1`
            echo "Adding macs to $HCA:$mlnx_port"

            cat <<EOF > $ADD_MAC
            #!/bin/bash
            #This script adds MACs to the physical interface
            while [ 1 ]; do
                macs=\`neutron port-list |awk '{print \$5}' |grep fa |egrep -v "\"10.0|\"172."\`
                for mac in \$macs; do
                    sudo bridge fdb add \$mac dev $mlnx_port
                    done
                done
            EOF
            nohup bash $ADD_MAC 2>&1|tee > /dev/null &
            cp $ADD_MAC ${WORKSPACE}/
            echo "FINISHED: ############## $phase  ###################"

- builder:
    name: delete-mac-nova
    builders:
        - shell: |
            #!/bin/bash
            phase="DELETE_MAC_NOVA"
            echo "STARTED: ############## $phase  ###################"
            if [[ "\$ZUUL_BRANCH" == "master" || -z "\$ZUUL_BRANCH" ]]; then
                exit 0
            fi
            ADD_MAC='/tmp/add_mac.sh'
            HCA=${HCA:-"mlx4"}
            echo "NOVA CI clean macs"
            kill -9 $(ps -ef |grep add_mac | grep -v grep | awk '{print $2}') 2>&1|tee > /dev/null
            rm -f $ADD_MAC 2>&1|tee > /dev/null

            mlnx_port=`ibdev2netdev |grep $HCA|grep Up | awk '{print $5}' | head -n1`
            echo "Removing macs from $HCA:$mlnx_port"

            tmp_file="/tmp/del_macs_$$"
            sudo bridge fdb show |grep fa:16 | awk '{print "sudo bridge fdb del " $1 " dev " $3}' > $tmp_file
            bash -x $tmp_file 2>&1|tee > /dev/null
            rm -f $tmp_file
            echo "FINISHED: ############## $phase  ###################"


- builder:
    name: configure-devstack-Cinder-ISER-ISCSI
    builders:
      - shell: |
          #!/bin/bash +e
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          export epioib_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|head -n1`
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi

          cat > devstack/local.conf <<EOF
          [[local|localrc]]
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          SERVICE_TOKEN=servicetoken

          LIBS_FROM_GIT=os-brick
          RECLONE=yes

          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          SCREEN_LOGDIR=$LOGDIR/screen
          LOGDAYS=2

          #Q_PLUGIN=$NeutronPlugin
          Q_USE_SECGROUP=True
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=$mlnx_port
          disable_service n-net heat h-api h-api-cfn h-api-cw h-eng n-cauth q-lbaas
          enable_service neutron q-svc q-agt q-dhcp q-l3 q-meta
          disable_service n-novnc n-xvnc horizon
          enable_service tempest

          SWIFT_HASH=password
          SWIFT_REPLICAS=1
          SWIFT_DATA_DIR=$DEST/data

          [[post-config|/etc/cinder/cinder.conf]]
          [DEFAULT]
          enabled_backends = lvmdriver-1, backend1, backend2

          [backend1]
          iscsi_ip_address=1.1.1.1
          iscsi_helper=tgtadm
          iscsi_protocol = iser
          iscsi_port = 3260
          volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver
          volume_backend_name = backend1
          volume_group = stack-volumes-lvmdriver-1

          [backend2]
          iscsi_ip_address=1.1.1.1
          iscsi_helper=tgtadm
          iscsi_protocol = iser
          iscsi_port = 3260
          volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver
          volume_backend_name = backend2
          volume_group = stack-volumes-lvmdriver-1

          [[post-extra|\$TEMPEST_CONFIG]]
          [volume]
          backend1_name = backend1
          backend2_name = backend2
          [volume-feature-enabled]
          multi_backend = True

          EOF

- builder:
    name: configure-devstack-Cinder-ISER-LIO
    builders:
      - shell: |
          #!/bin/bash +e
          HCA=${HCA:-"mlx4"}
          mlx=`echo $HCA | sed s/mlx//g`
          let mlx=mlx-1
          export mlnx_dev=`lspci |grep Mell|grep "\-$mlx" |head -n1|awk '{print $1}' |  sed s/\.0\$//g`
          export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`
          export epioib_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|head -n1`
          if [ -z "$mlnx_dev" ] || [ -z "$mlnx_port" ]; then
              exit 1
          fi

          cat > devstack/local.conf <<EOF
          [[local|localrc]]
          HOST_IP=$(host $(hostname) | cut -d' ' -f4)
          ADMIN_PASSWORD=password
          MYSQL_PASSWORD=password
          RABBIT_PASSWORD=password
          SERVICE_PASSWORD=password
          SERVICE_TOKEN=servicetoken
          mlnx_dev=$mlnx_dev
          mlnx_port=$mlnx_port

          LIBS_FROM_GIT=os-brick
          RECLONE=yes

          LOGDIR=${LOGDIR:-/opt/stack/logs}
          LOGFILE=$LOGDIR/stack.sh.log
          SCREEN_LOGDIR=$LOGDIR/screen
          LOGDAYS=2

          #Q_PLUGIN=$NeutronPlugin
          Q_USE_SECGROUP=True
          PHYSICAL_NETWORK=default
          PHYSICAL_INTERFACE=$mlnx_port
          disable_service n-net heat h-api h-api-cfn h-api-cw h-eng q-lbaas n-cauth
          enable_service neutron q-svc q-agt q-dhcp q-l3 q-meta
          disable_service n-novnc n-xvnc horizon
          enable_service tempest

          SWIFT_HASH=password
          SWIFT_REPLICAS=1
          SWIFT_DATA_DIR=$DEST/data

          [[post-config|/etc/cinder/cinder.conf]]
          [DEFAULT]
          iscsi_helper=lioadm
          enabled_backends =lvmdriver-1,backend1, backend2

          [lvmdriver-1]
          iscsi_ip_address=1.1.1.1
          iscsi_helper=lioadm
          iscsi_port = 3261
          volume_group = stack-volumes-lvmdriver-1
          iscsi_protocol = iser
          volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver
          volume_backend_name = lvmdriver-1


          [backend1]
          iscsi_ip_address=1.1.1.1
          iscsi_helper=lioadm
          iscsi_protocol = iser
          iscsi_port = 3261
          volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver
          volume_backend_name = backend1
          volume_group = stack-volumes-lvmdriver-1

          [backend2]
          iscsi_ip_address=1.1.1.1
          iscsi_helper=lioadm
          iscsi_protocol = iser
          iscsi_port = 3261
          volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver
          volume_backend_name = backend2
          volume_group = stack-volumes-lvmdriver-1

          [[post-extra|\$TEMPEST_CONFIG]]
          [volume]
          backend1_name = backend1
          backend2_name = backend2
          [volume-feature-enabled]
          multi_backend = True
          EOF


- builder:
    name: run-tests-cinder
    builders:
      - shell: |
                #!/bin/bash +ex

                HCA=${HCA:-"mlx4"}
                mlx=`echo $HCA | sed s/mlx//g`
                let mlx=mlx-1
                export mlnx_port=`ibdev2netdev  | grep ${HCA}_0 | grep Up| awk '{print $5}'|tail -n1`

                sudo ifconfig $mlnx_port 1.1.1.1/32 up

                echo "============ Starting tempest tests ====================="
                tests=(tempest.scenario.test_encrypted_cinder_volumes.TestEncryptedCinderVolumes
                       tempest.scenario.test_minimum_basic.TestMinimumBasicScenario
                       tempest.scenario.test_snapshot_pattern.TestSnapshotPattern
                       tempest.scenario.test_volume_boot_pattern.TestVolumeBootPattern
                       tempest.scenario.test_volume_boot_pattern.TestVolumeBootPatternV2
                       tempest.scenario.test_stamp_pattern.TestStampPattern
                )
                cd /opt/stack/tempest
                testr init
                testr list-tests ${tests[@]}
                testr run ${tests[@]}
                test_pass=$?

                #sudo ifconfig $mlnx_port down

                if [[ $test_pass -ne 0 ]]; then
                    echo "FINISHED with ERROR: ############## $phase  ###################"
                    exit 1
                fi

- builder:
    name: mlnx-debian-build
    builders:
      - shell: |
               #!/usr/bin/python
               import json
               import urllib2
               import sys
               import os
               #import ssl
               #from pprint import pprint
               #ssl._create_default_https_context = ssl._create_unverified_context

               #curl http://10.209.32.40:8080/job/Check-MLNX-Neutron-ML2-driver/lastBuild/api/json 2>/dev/null|python -m json.tool  |grep openstack
               #https://mitaka-jessie.pkgs.mirantis.com/job/networking-mlnx/api/json

               MLNX_CI = [{'Jenkins' :'mitaka-jessie.pkgs.mirantis.com', 'Projects': ['networking-mlnx',],}]

               HISTORY_JOBS=10

               def find_last_jobs(jenkins, project):
                   status = 0
                   url = 'https://%s/job/%s/api/json' % ( jenkins, project )
                   l = json.load(urllib2.urlopen(url))
                   last_jobs = []
                   for job_id in l['builds'][0:HISTORY_JOBS]:
                       last_jobs.append(job_id['url'])

                   for job in last_jobs:
                       j = json.load(urllib2.urlopen('%s/api/json' % job))
                       print "%s    %s" % (j['result'], j['url'])
                       if j['result'] == 'SUCCESS':
                           continue

                       if j['result'] == 'FAILURE': # or j['result'] == "ABORTED"
                        status = 1

                   return status

               sys.exit(find_last_jobs('mitaka-jessie.pkgs.mirantis.com', 'networking-mlnx'))


